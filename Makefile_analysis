#
# variables
#
DSELECTOR_MACROS = call_DSelector2.C DSelector_Z2pi0_trees2.C DSelector_Z2pi0_trees2.h

PLOT_MACROS = plot_Z2pi_trees.C

FLAT_MACROS = call_MakeAmpToolsFlat_pi0.C MakeAmpToolsFlat_pi0.C MakeAmpToolsFlat_pi0.h

PHASE_SPACE_EVENT_MACROS = call_MakeAmpToolsFlat_mcthrown_pi0.C MakeAmpToolsFlat_mcthrown_pi0.C MakeAmpToolsFlat_mcthrown_pi0.h
#
# rules
#
all: twopi_primakoff.pdf twopi_primakoff_sum.pdf

dsplots: DSelector_Z2pi0_trees_sig.pdf DSelector_Z2pi0_trees_ps.pdf
#
# get the data from the MC run, add multiple files together, for signal or phase space by setting the % token properly
#
tree_pi0pi0misspb208_%.root: /work/halld/home/marki/npp_output/root/trees/tree_pi0pi0misspb208__B2_gen_2pi0_primakoff_%_030300_000.root
	rm -fv $@
	hadd $@ $<

%.C: $(NPP)/root_macros/%.C
	cp -v $< $@

%.h: $(NPP)/root_macros/%.h
	cp -v $< $@
#
# 2.2 and 5.2 Run the DSelector
#
DSelector_Z2pi0_trees_%.root \
tree_DSelector_Z2pi0_trees_%.root \
treeFlat_DSelector_Z2pi0_trees_%.root: tree_pi0pi0misspb208_%.root $(DSELECTOR_MACROS)
	root -b -q $< 'call_DSelector2.C("DSelector_Z2pi0_trees2.C+")'
	mv -v DSelector_Z2pi0_trees2.root DSelector_Z2pi0_trees_$*.root
	mv -v tree_DSelector_Z2pi0_trees.root tree_DSelector_Z2pi0_trees_$*.root
	mv -v treeFlat_DSelector_Z2pi0_trees.root treeFlat_DSelector_Z2pi0_trees_$*.root
#
# 2.3 and 5.3 Make plots for DSelector run
#
DSelector_Z2pi0_trees_%.pdf EgP1P2_signal_DSelector_%.pdf: DSelector_Z2pi0_trees_%.root $(PLOT_MACROS)
	root -b -q  plot_Z2pi_trees.C\(\"DSelector_Z2pi0_trees_$*\"\)
	mv -v EgP1P2_signal_DSelector.pdf EgP1P2_signal_DSelector_$*.pdf
#
# 3. Prepare four samples from signal MC for AmpTools
#
treeFlat_DSelector_Z2pi0_trees_signal_amptools_W.root: treeFlat_DSelector_Z2pi0_trees_sig.root $(FLAT_MACROS)
	root -b -q $< 'call_MakeAmpToolsFlat_pi0.C(1)'
	mv -v AmpToolsInputTree.root $@
treeFlat_DSelector_Z2pi0_trees_signal_amptools_InTime.root: treeFlat_DSelector_Z2pi0_trees_sig.root $(FLAT_MACROS)
	root -b -q $< 'call_MakeAmpToolsFlat_pi0.C(2)'
	mv -v AmpToolsInputTreeInTime.root $@
treeFlat_DSelector_Z2pi0_trees_signal_amptools_OutTime.root: treeFlat_DSelector_Z2pi0_trees_sig.root $(FLAT_MACROS)
	root -b -q $< 'call_MakeAmpToolsFlat_pi0.C(3)'
	mv -v AmpToolsInputTreeOutTime.root $@
treeFlat_DSelector_Z2pi0_trees_signal_amptools_InTimeW.root: treeFlat_DSelector_Z2pi0_trees_sig.root $(FLAT_MACROS)
	root -b -q $< 'call_MakeAmpToolsFlat_pi0.C(4)'
	mv -v AmpToolsInputTreeInTimeW.root $@
#
# 4.1 make root tree with phase space event sample
#
tree_hd_root_Z2pi0_trees_flat_gen.root: /work/halld/home/marki/npp_output/hddm/dana_rest_gen_2pi0_primakoff_ps_030300_000.hddm
	hd_root -PPLUGINS=monitoring_hists,mcthrown_tree -PNTHREADS=4 /work/halld/home/marki/npp_output/hddm/dana_rest_gen_2pi0_primakoff_ps_030300_000.hddm -o hd_root_Z2pi0_trees_flat_gen.root
	mv -v tree_thrown.root $@
#
# 4.2 change space generated event root tree into AmpTools format
#
treeFlat_gen_2pi0_primakoff_flat_amptools.root: tree_hd_root_Z2pi0_trees_flat_gen.root $(PHASE_SPACE_EVENT_MACROS)
	root -b -q $< 'call_MakeAmpToolsFlat_mcthrown_pi0.C'
	mv -v AmpToolsInputTree.root $@
#
# 5.3 prepare phase space accepted events for AmpTools 
#
treeFlat_DSelector_Z2pi0_trees_flat_amptools_InTime.root: treeFlat_DSelector_Z2pi0_trees_ps.root $(FLAT_MACROS)
	root -b -q $< 'call_MakeAmpToolsFlat_pi0.C(2)'
	mv -v AmpToolsInputTreeInTime.root $@
#
# 6. do the AmpTools fit
#
twopi0_primakoff.fit twopi0_primakoff_ni.txt: treeFlat_gen_2pi0_primakoff_flat_amptools.root treeFlat_DSelector_Z2pi0_trees_flat_amptools_InTime.root treeFlat_DSelector_Z2pi0_trees_signal_amptools_W.root
#
	fit -c $(NPP)/amptools_config/fit_2pi0_primakoff.cfg
#
# 7.1 Transform fit results to a root file
#
twopi_primakoff.root twopi_primakoff.fit2: twopi0_primakoff.fit
	twopi_plotter_primakoff twopi0_primakoff.fit -o twopi_primakoff.root
	mv -v twopi_fitPars.txt twopi_primakoff.fit2
#
# 7.2 Plot the fit results
#
twopi_primakoff.pdf twopi_primakoff_sum.pdf: twopi_primakoff.root twopi_primakoff.fit2 twopi_primakoff.C
	root -b -q twopi_primakoff.C\(\"twopi_primakoff\",10000\)
#
# clean
#
clean:
	rm -fv *.pcm *.d *.so *.pdf *.root *.C *.h *.fit *.txt *.fit2